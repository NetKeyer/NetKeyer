name: Build Multi-Platform Installers

on:
  push:
    tags:
      - 'v*'  # Trigger on version tags like v1.0.0
  workflow_dispatch:  # Allow manual triggering
    inputs:
      version:
        description: 'Version number (e.g., 1.0.0)'
        required: true
        default: '1.0.0'

jobs:
  build-windows:
    name: Build Windows Installer
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'

    - name: Determine version
      id: version
      shell: pwsh
      run: |
        if ("${{ github.event_name }}" -eq "push" -and "${{ github.ref }}" -like "refs/tags/v*") {
          $version = "${{ github.ref }}" -replace "refs/tags/v", ""
        } elseif ("${{ github.event.inputs.version }}" -ne "") {
          $version = "${{ github.event.inputs.version }}"
        } else {
          $version = "0.0.1-dev"
        }
        echo "VERSION=$version" >> $env:GITHUB_OUTPUT
        echo "Building version: $version"

    - name: Restore dependencies
      run: dotnet restore NetKeyer.csproj

    - name: Install vpk tool
      run: dotnet tool install -g vpk

    - name: Build and publish
      run: |
        dotnet publish NetKeyer.csproj `
          -c Release `
          --self-contained true `
          -r win-x64 `
          -p:PublishSingleFile=false `
          -p:Version=${{ steps.version.outputs.VERSION }} `
          -o publish

    - name: Create Azure Trusted Signing metadata file
      shell: pwsh
      run: |
        $metadata = @{
          Endpoint = "${{ secrets.AZURE_ENDPOINT }}"
          CodeSigningAccountName = "${{ secrets.AZURE_CODE_SIGNING_NAME }}"
          CertificateProfileName = "${{ secrets.AZURE_CERT_PROFILE_NAME }}"
        }
        $metadata | ConvertTo-Json | Set-Content -Path "azure-signing.json"
        Write-Host "Created Azure signing metadata file"

    - name: Azure CLI Login
      uses: azure/login@v2
      with:
        creds: '{"clientId":"${{ secrets.AZURE_CLIENT_ID }}","clientSecret":"${{ secrets.AZURE_CLIENT_SECRET }}","tenantId":"${{ secrets.AZURE_TENANT_ID }}","subscriptionId":"${{ secrets.AZURE_SUBSCRIPTION_ID }}"}'

    - name: Package with Velopack (with Azure signing)
      run: |
        vpk pack `
          --packId "NetKeyer" `
          --packVersion ${{ steps.version.outputs.VERSION }} `
          --packDir publish `
          --mainExe NetKeyer.exe `
          --packTitle "NetKeyer" `
          --packAuthors "NetKeyer Contributors" `
          --runtime win-x64 `
          --channel win-x64 `
          --azureTrustedSignFile azure-signing.json

    - name: Upload Windows artifacts
      uses: actions/upload-artifact@v4
      with:
        name: netkeyer-windows-x64-v${{ steps.version.outputs.VERSION }}
        path: Releases/*
        retention-days: 90

  build-linux:
    name: Build Linux Installers
    runs-on: ubuntu-latest
    strategy:
      matrix:
        arch: [x64, arm64]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'

    - name: Determine version
      id: version
      shell: bash
      run: |
        if [[ "${{ github.event_name }}" == "push" && "${{ github.ref }}" == refs/tags/v* ]]; then
          version="${{ github.ref }}"
          version="${version#refs/tags/v}"
        elif [[ -n "${{ github.event.inputs.version }}" ]]; then
          version="${{ github.event.inputs.version }}"
        else
          version="0.0.1-dev"
        fi
        echo "VERSION=$version" >> $GITHUB_OUTPUT
        echo "Building version: $version"

    - name: Restore dependencies
      run: dotnet restore NetKeyer.csproj

    - name: Install vpk tool
      run: dotnet tool install -g vpk

    - name: Build and publish
      run: |
        dotnet publish NetKeyer.csproj \
          -c Release \
          --self-contained true \
          -r linux-${{ matrix.arch }} \
          -p:PublishSingleFile=false \
          -p:Version=${{ steps.version.outputs.VERSION }} \
          -o publish

    - name: Package with Velopack
      run: |
        vpk pack \
          --packId "NetKeyer" \
          --packVersion ${{ steps.version.outputs.VERSION }} \
          --packDir publish \
          --mainExe NetKeyer \
          --packTitle "NetKeyer" \
          --packAuthors "NetKeyer Contributors" \
          --runtime linux-${{ matrix.arch }} \
          --channel linux-${{ matrix.arch }}

    - name: Upload Linux ${{ matrix.arch }} artifacts
      uses: actions/upload-artifact@v4
      with:
        name: netkeyer-linux-${{ matrix.arch }}-v${{ steps.version.outputs.VERSION }}
        path: Releases/*
        retention-days: 90

  build-macos:
    name: Build macOS Installers
    runs-on: macos-latest
    strategy:
      matrix:
        arch: [x64, arm64]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'

    - name: Determine version
      id: version
      shell: bash
      run: |
        if [[ "${{ github.event_name }}" == "push" && "${{ github.ref }}" == refs/tags/v* ]]; then
          version="${{ github.ref }}"
          version="${version#refs/tags/v}"
        elif [[ -n "${{ github.event.inputs.version }}" ]]; then
          version="${{ github.event.inputs.version }}"
        else
          version="0.0.1-dev"
        fi
        echo "VERSION=$version" >> $GITHUB_OUTPUT
        echo "Building version: $version"

    - name: Restore dependencies
      run: dotnet restore NetKeyer.csproj

    - name: Install vpk tool
      run: dotnet tool install -g vpk

    - name: Build and publish
      run: |
        dotnet publish NetKeyer.csproj \
          -c Release \
          --self-contained true \
          -r osx-${{ matrix.arch }} \
          -p:PublishSingleFile=false \
          -p:Version=${{ steps.version.outputs.VERSION }} \
          -o publish

    - name: Package with Velopack
      run: |
        vpk pack \
          --packId "NetKeyer" \
          --packVersion ${{ steps.version.outputs.VERSION }} \
          --packDir publish \
          --mainExe NetKeyer \
          --packTitle "NetKeyer" \
          --packAuthors "NetKeyer Contributors" \
          --runtime osx-${{ matrix.arch }} \
          --channel osx-${{ matrix.arch }}

    - name: Upload macOS ${{ matrix.arch }} artifacts
      uses: actions/upload-artifact@v4
      with:
        name: netkeyer-macos-${{ matrix.arch }}-v${{ steps.version.outputs.VERSION }}
        path: Releases/*
        retention-days: 90

  create-release:
    name: Create GitHub Release
    needs: [build-windows, build-linux, build-macos]
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Determine version
      id: version
      run: |
        version="${{ github.ref }}"
        version="${version#refs/tags/v}"
        echo "VERSION=$version" >> $GITHUB_OUTPUT

    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts

    - name: Display structure of downloaded files
      run: ls -R artifacts

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        files: artifacts/**/*
        draft: false
        prerelease: false
        generate_release_notes: true
        body: |
          ## NetKeyer v${{ steps.version.outputs.VERSION }}

          ### Downloads

          **Windows (x64):**
          - [NetKeyer-win-x64-Setup.exe](https://github.com/${{ github.repository }}/releases/download/v${{ steps.version.outputs.VERSION }}/NetKeyer-win-x64-Setup.exe) - Windows x64 installer

          **Linux:**
          - [NetKeyer-linux-x64.AppImage](https://github.com/${{ github.repository }}/releases/download/v${{ steps.version.outputs.VERSION }}/NetKeyer-linux-x64.AppImage) - Linux x64 AppImage
          - [NetKeyer-linux-arm64.AppImage](https://github.com/${{ github.repository }}/releases/download/v${{ steps.version.outputs.VERSION }}/NetKeyer-linux-arm64.AppImage) - Linux ARM64 AppImage

          **macOS:**
          - [NetKeyer-osx-x64-Setup.pkg](https://github.com/${{ github.repository }}/releases/download/v${{ steps.version.outputs.VERSION }}/NetKeyer-osx-x64-Setup.pkg) - macOS Intel (x64) installer
          - [NetKeyer-osx-arm64-Setup.pkg](https://github.com/${{ github.repository }}/releases/download/v${{ steps.version.outputs.VERSION }}/NetKeyer-osx-arm64-Setup.pkg) - macOS Apple Silicon (ARM64) installer

          ### Auto-Updates
          All installers include automatic update support. Click "Check for Updates" in the Help â†’ About window.
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
