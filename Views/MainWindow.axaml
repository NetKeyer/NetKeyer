<Window xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:vm="using:NetKeyer.ViewModels"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        mc:Ignorable="d" d:DesignWidth="600" d:DesignHeight="500"
        x:Class="NetKeyer.Views.MainWindow"
        x:DataType="vm:MainWindowViewModel"
        Title="NetKeyer - FlexRadio CW Keyer"
        Width="600"
        MinWidth="500"
        SizeToContent="Height"
        CanResize="True">

    <Design.DataContext>
        <vm:MainWindowViewModel/>
    </Design.DataContext>

    <DockPanel LastChildFill="False">
        <!-- Menu Bar (hidden on macOS, where we use the native menu bar) -->
        <Menu DockPanel.Dock="Top" IsVisible="{Binding IsMenuBarInWindow}">
            <MenuItem Header="_File">
                <MenuItem Header="_Disconnect" 
                          Command="{Binding ToggleConnectionCommand}"
                          IsVisible="{Binding IsOperatingPage}"/>
                <Separator IsVisible="{Binding IsOperatingPage}"/>
                <MenuItem Header="E_xit" Command="{Binding ExitCommand}"/>
            </MenuItem>
            <MenuItem Header="_Settings">
                <MenuItem Header="_Audio Output Device..." Command="{Binding SelectAudioDeviceCommand}"/>
                <MenuItem Header="_MIDI Note Mapping..." Command="{Binding ConfigureMidiNotesCommand}"/>
            </MenuItem>
            <MenuItem Header="_Help">
                <MenuItem Header="_Documentation" Command="{Binding OpenDocumentationCommand}"/>
                <MenuItem Header="_View Debug Log..." Command="{Binding OpenDebugLogCommand}"/>
                <MenuItem Header="_About NetKeyer..." Command="{Binding ShowAboutCommand}"/>
            </MenuItem>
        </Menu>

        <!-- Status Bar at Bottom -->
        <Border DockPanel.Dock="Bottom" 
                BorderBrush="Gray" 
                BorderThickness="0,1,0,0" 
                Background="#F0F0F0"
                Padding="8,4"
                IsVisible="{Binding IsOperatingPage}">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>
                
                <!-- Left side: Station/Radio Name -->
                <TextBlock Grid.Column="0" 
                           Text="{Binding StatusBarStationRadio}"
                           VerticalAlignment="Center"
                           FontSize="12"
                           FontWeight="SemiBold"/>
                
                <!-- Middle: Keyer Mode and Speed -->
                <TextBlock Grid.Column="1" 
                           Text="{Binding StatusBarInfo}"
                           VerticalAlignment="Center"
                           FontSize="11"
                           Foreground="Gray"
                           Margin="15,0,0,0"/>
                
                <!-- Right side: Keyer Status LED -->
                <StackPanel Grid.Column="2" 
                            Orientation="Horizontal" 
                            Spacing="6"
                            VerticalAlignment="Center">
                    <TextBlock Text="Keyer" 
                               FontSize="12" 
                               VerticalAlignment="Center"/>
                    <Border Width="16" 
                            Height="16" 
                            CornerRadius="8"
                            Background="{Binding KeyerStatusLedColor}"
                            BorderBrush="DarkGray"
                            BorderThickness="1"/>
                </StackPanel>
            </Grid>
        </Border>

        <!-- Main Content -->
        <ScrollViewer DockPanel.Dock="Top"
                      VerticalScrollBarVisibility="Auto" 
                      HorizontalScrollBarVisibility="Disabled">
            <StackPanel Margin="10" Spacing="8">

                <!-- Setup Page -->
                <StackPanel Spacing="8" IsVisible="{Binding IsSetupPage}">

                    <!-- SmartLink Section -->
                    <Border BorderBrush="Gray" BorderThickness="1" Padding="8" CornerRadius="3"
                            IsVisible="{Binding SmartLinkAvailable}">
                        <StackPanel Spacing="6">
                            <TextBlock Text="SmartLink" FontWeight="Bold" FontSize="14"/>

                            <StackPanel Orientation="Horizontal" Spacing="6">
                                <Button Content="{Binding SmartLinkButtonText}"
                                        Command="{Binding ToggleSmartLinkCommand}"
                                        Width="180"
                                        HorizontalContentAlignment="Center"
                                        Padding="4"/>
                                <TextBlock Text="{Binding SmartLinkStatus}"
                                           VerticalAlignment="Center"
                                           FontSize="12"/>
                            </StackPanel>
                        </StackPanel>
                    </Border>

                    <!-- Radio Selection -->
                    <Border BorderBrush="Gray" BorderThickness="1" Padding="8" CornerRadius="3">
                        <StackPanel Spacing="6">
                            <TextBlock Text="Radio Selection" FontWeight="Bold" FontSize="14"/>

                            <StackPanel Orientation="Horizontal" Spacing="6">
                                <ComboBox Name="RadioComboBox"
                                          ItemsSource="{Binding RadioClientSelections}"
                                          SelectedItem="{Binding SelectedRadioClient}"
                                          Width="450"
                                          PlaceholderText="Select a radio and station..."/>
                                <Button Content="Refresh"
                                        Command="{Binding RefreshRadiosCommand}"
                                        Width="70"
                                        HorizontalContentAlignment="Center"
                                        Padding="4"/>
                            </StackPanel>

                            <!-- Status - only shown on error -->
                            <TextBlock Text="{Binding RadioStatus}"
                                       Foreground="{Binding RadioStatusColor}"
                                       IsVisible="{Binding HasRadioError}"
                                       TextWrapping="Wrap"/>
                        </StackPanel>
                    </Border>

                    <!-- Input Device Selection -->
                    <Border BorderBrush="Gray" BorderThickness="1" Padding="8" CornerRadius="3">
                        <StackPanel Spacing="6">
                            <TextBlock Text="Input Device Selection" FontWeight="Bold" FontSize="14"/>

                            <!-- Input Type Selector -->
                            <StackPanel Spacing="3">
                                <TextBlock Text="Input Type:" FontSize="12"/>
                                <StackPanel Orientation="Horizontal" Spacing="15">
                                    <RadioButton Content="Serial Port (HaliKey v1)"
                                                 GroupName="InputType"
                                                 IsChecked="{Binding IsSerialInput}"
                                                 Padding="2"/>
                                    <RadioButton Content="MIDI (HaliKey MIDI, CTR2)"
                                                 GroupName="InputType"
                                                 IsChecked="{Binding IsMidiInput}"
                                                 Padding="2"/>
                                </StackPanel>
                            </StackPanel>

                            <!-- Serial Port Settings -->
                            <StackPanel Spacing="6" IsVisible="{Binding IsSerialInput}">
                                <StackPanel Orientation="Horizontal" Spacing="6">
                                    <TextBlock Text="Port:" VerticalAlignment="Center" Width="110"/>
                                    <ComboBox ItemsSource="{Binding SerialPorts}"
                                              SelectedItem="{Binding SelectedSerialPort}"
                                              Width="280"
                                              PlaceholderText="Select a port..."/>
                                    <Button Content="Refresh"
                                            Command="{Binding RefreshSerialPortsCommand}"
                                            Width="70"
                                            HorizontalContentAlignment="Center"
                                            Padding="4"/>
                                </StackPanel>
                            </StackPanel>

                            <!-- MIDI Device Settings -->
                            <StackPanel Spacing="6" IsVisible="{Binding IsMidiInput}">
                                <StackPanel Orientation="Horizontal" Spacing="6">
                                    <TextBlock Text="MIDI Device:" VerticalAlignment="Center" Width="100"/>
                                    <ComboBox ItemsSource="{Binding MidiDevices}"
                                              SelectedItem="{Binding SelectedMidiDevice}"
                                              Width="280"
                                              PlaceholderText="Select a MIDI device..."/>
                                    <Button Content="Refresh"
                                            Command="{Binding RefreshMidiDevicesCommand}"
                                            Width="70"
                                            HorizontalContentAlignment="Center"
                                            Padding="4"/>
                                </StackPanel>
                            </StackPanel>
                        </StackPanel>
                    </Border>

                    <!-- Connect Button -->
                    <Button Content="Connect"
                            Command="{Binding ToggleConnectionCommand}"
                            HorizontalAlignment="Center"
                            HorizontalContentAlignment="Center"
                            Width="120"
                            Padding="6"
                            Margin="0,5,0,0"/>
                </StackPanel>

                <!-- Operating Page -->
                <StackPanel Spacing="8" IsVisible="{Binding IsOperatingPage}">

                    <!-- CW Settings Section with Collapsible Content -->
                    <Border BorderBrush="Gray" BorderThickness="1" Padding="8" CornerRadius="3"
                            IsVisible="{Binding CwSettingsVisible}">
                        <StackPanel Spacing="6">
                            <!-- Header with expand/collapse button -->
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>
                                
                                <Button Grid.Column="0" 
                                        Command="{Binding ToggleCWSettingsCommand}"
                                        Background="Transparent"
                                        BorderThickness="0"
                                        Padding="0"
                                        Margin="0,0,8,0"
                                        Width="20"
                                        Height="20"
                                        Content="{Binding CwSettingsExpandArrow}"
                                        FontSize="12"
                                        FontWeight="Bold"
                                        HorizontalContentAlignment="Center"
                                        VerticalContentAlignment="Center"/>
                                
                                <TextBlock Grid.Column="1" 
                                           Text="CW Settings" 
                                           FontWeight="Bold" 
                                           FontSize="14"
                                           VerticalAlignment="Center"/>
                            </Grid>

                            <!-- Collapsible Settings Content -->
                            <StackPanel Spacing="6" IsVisible="{Binding CwSettingsExpanded}">

                            <!-- Speed -->
                            <StackPanel Orientation="Horizontal" Spacing="6">
                                <TextBlock Text="Speed (WPM):" Width="100" VerticalAlignment="Center"/>
                                <TextBlock Text="{Binding CwSpeed}" Width="25" VerticalAlignment="Center"/>
                                <Slider Minimum="5" Maximum="60"
                                        Value="{Binding CwSpeed}"
                                        TickFrequency="5"
                                        Width="250"
                                        VerticalAlignment="Center"/>
                            </StackPanel>

                            <!-- Sidetone Volume -->
                            <StackPanel Orientation="Horizontal" Spacing="6">
                                <TextBlock Text="Sidetone:" Width="100" VerticalAlignment="Center"/>
                                <TextBlock Text="{Binding SidetoneVolume}" Width="25" VerticalAlignment="Center"/>
                                <Slider Minimum="0" Maximum="100"
                                        Value="{Binding SidetoneVolume}"
                                        TickFrequency="10"
                                        Width="250"
                                        VerticalAlignment="Center"/>
                            </StackPanel>

                            <!-- Pitch -->
                            <StackPanel Orientation="Horizontal" Spacing="6">
                                <TextBlock Text="Pitch (Hz):" Width="100" VerticalAlignment="Center"/>
                                <TextBlock Text="{Binding CwPitch}" Width="25" VerticalAlignment="Center"/>
                                <Slider Minimum="300" Maximum="1000"
                                        Value="{Binding CwPitch}"
                                        TickFrequency="50"
                                        Width="250"
                                        VerticalAlignment="Center"/>
                            </StackPanel>

                            <!-- Mode Selection -->
                            <StackPanel Spacing="3">
                                <TextBlock Text="Keyer Mode:" FontSize="12"/>
                                <StackPanel Orientation="Horizontal" Spacing="15">
                                    <RadioButton Content="Iambic"
                                                 GroupName="KeyerMode"
                                                 IsChecked="{Binding IsIambicMode}"
                                                 Padding="2"/>
                                    <RadioButton Content="Straight Key"
                                                 GroupName="KeyerMode"
                                                 IsChecked="{Binding !IsIambicMode}"
                                                 Padding="2"/>
                                </StackPanel>
                            </StackPanel>

                            <!-- Iambic Mode Selection (A vs B) -->
                            <StackPanel Spacing="3">
                                <TextBlock Text="Iambic Type:" FontSize="12"/>
                                <StackPanel Orientation="Horizontal" Spacing="15">
                                    <RadioButton Content="Mode A"
                                                 GroupName="IambicType"
                                                 IsChecked="{Binding !IsIambicModeB}"
                                                 IsEnabled="{Binding IsIambicMode}"
                                                 Padding="2"/>
                                    <RadioButton Content="Mode B"
                                                 GroupName="IambicType"
                                                 IsChecked="{Binding IsIambicModeB}"
                                                 IsEnabled="{Binding IsIambicMode}"
                                                 Padding="2"/>
                                </StackPanel>
                            </StackPanel>

                            <!-- Swap Paddles -->
                            <CheckBox Content="Swap Paddles (Left ↔ Right)"
                                      IsChecked="{Binding SwapPaddles}"
                                      Padding="2"/>
                            </StackPanel>
                        </StackPanel>
                    </Border>

                    <!-- CW Monitor Section -->
                    <Border BorderBrush="Gray" BorderThickness="1" Padding="8" CornerRadius="3"
                            IsVisible="{Binding CwSettingsVisible}">
                        <StackPanel Spacing="6">
                            <!-- Title and functional buttons -->
                            <StackPanel Orientation="Horizontal" Spacing="10">
                                <TextBlock Text="CW Monitor" FontWeight="Bold" FontSize="14" VerticalAlignment="Center"/>
                                <ToggleButton IsChecked="{Binding CwMonitorEnabled}"
                                              VerticalAlignment="Center"
                                              HorizontalContentAlignment="Center"
                                              Padding="6,2"
                                              FontSize="11"
                                              MinWidth="75">
                                    <ToggleButton.Styles>
                                        <Style Selector="ToggleButton">
                                            <Setter Property="Content" Value="Disabled"/>
                                        </Style>
                                        <Style Selector="ToggleButton:checked">
                                            <Setter Property="Content" Value="Enabled"/>
                                        </Style>
                                    </ToggleButton.Styles>
                                </ToggleButton>
                                <Button Content="{Binding CwAlgorithmMode}"
                                        Command="{Binding ToggleAlgorithmModeCommand}"
                                        FontSize="11"
                                        Padding="4,2"
                                        Width="140"
                                        HorizontalContentAlignment="Center"
                                        VerticalAlignment="Center"
                                        IsVisible="{Binding CwMonitorEnabled}"
                                        ToolTip.Tip="Toggle between Dense Neural Network and Statistical Timing"/>
                                <Button Content="Reset Stats"
                                        Command="{Binding ResetCWMonitorStatsCommand}"
                                        FontSize="11"
                                        Padding="4,2"
                                        Width="80"
                                        HorizontalContentAlignment="Center"
                                        VerticalAlignment="Center"
                                        IsVisible="{Binding CwMonitorEnabled}"
                                        ToolTip.Tip="Clear timing statistics and re-learn keying speed"/>
                                <Button Content="Clear Buffer"
                                        Command="{Binding ClearCWMonitorBufferCommand}"
                                        FontSize="11"
                                        Padding="4,2"
                                        Width="80"
                                        HorizontalContentAlignment="Center"
                                        VerticalAlignment="Center"
                                        IsVisible="{Binding CwMonitorEnabled}"
                                        ToolTip.Tip="Clear the decoded CW text buffer"/>
                            </StackPanel>

                            <!-- Decoded CW Display -->
                            <Border BorderBrush="DarkGray" BorderThickness="1" Background="#F5F5F5" Padding="6" CornerRadius="2"
                                    IsVisible="{Binding CwMonitorEnabled}">
                                <TextBlock Text="{Binding DecodedCW}"
                                           FontFamily="Consolas,Courier New,monospace"
                                           FontSize="16"
                                           FontWeight="Bold"
                                           MinHeight="30"
                                           TextWrapping="Wrap"
                                           VerticalAlignment="Center"/>
                            </Border>

                            <!-- DNN Diagnostics Section (shown only in DNN mode) -->
                            <Border BorderBrush="LightGray" BorderThickness="0,1,0,0" Padding="0,6,0,0" Margin="0,4,0,0"
                                    IsVisible="{Binding IsDnnMode}">
                                <StackPanel Spacing="4">
                                    <!-- Header Row with Mode Indicator -->
                                    <StackPanel Orientation="Horizontal" Spacing="6" HorizontalAlignment="Center">
                                        <TextBlock Text="Diagnostics" FontSize="10" FontWeight="SemiBold" 
                                                   Foreground="Gray" VerticalAlignment="Center"
                                                   ToolTip.Tip="{Binding ModelInfoTooltip}"/>
                                        <TextBlock Text="•" FontSize="10" Foreground="LightGray" VerticalAlignment="Center"/>
                                        <TextBlock Text="Mode:" FontSize="10" Foreground="Gray" VerticalAlignment="Center"/>
                                        <TextBlock Text="{Binding AlgorithmModeDisplay}" FontSize="10" 
                                                   FontWeight="Bold" VerticalAlignment="Center"/>
                                        <TextBlock Text="{Binding DnnStatus}" FontSize="10" 
                                                   Foreground="LimeGreen" VerticalAlignment="Center"
                                                   IsVisible="{Binding IsDnnLoaded}"/>
                                    </StackPanel>
                                    
                                    <!-- Last Classification Row -->
                                    <Border Background="#F0F0F0" Padding="4" CornerRadius="2" Margin="0,2">
                                        <TextBlock Text="{Binding LastClassificationDisplay}" 
                                                   FontSize="10" FontFamily="Consolas,Courier New,monospace"
                                                   Foreground="{Binding LastClassificationColor}"
                                                   HorizontalAlignment="Center"/>
                                    </Border>
                                    
                                    <!-- Confidence Statistics Row -->
                                    <StackPanel Orientation="Horizontal" Spacing="10" HorizontalAlignment="Center">
                                        <TextBlock FontSize="9" Foreground="Gray">
                                            <Run Text="High: "/>
                                            <Run Text="{Binding HighConfidencePercent}" FontWeight="Bold"/>
                                        </TextBlock>
                                        <TextBlock FontSize="9" Foreground="Gray">
                                            <Run Text="Med: "/>
                                            <Run Text="{Binding MediumConfidencePercent}" FontWeight="Bold"/>
                                        </TextBlock>
                                        <TextBlock FontSize="9" Foreground="Gray">
                                            <Run Text="Low: "/>
                                            <Run Text="{Binding LowConfidencePercent}" FontWeight="Bold"/>
                                        </TextBlock>
                                    </StackPanel>
                                </StackPanel>
                            </Border>

                            <!-- Statistical Diagnostics Section (shown only in Statistical mode) -->
                            <Border BorderBrush="LightGray" BorderThickness="0,1,0,0" Padding="0,6,0,0" Margin="0,4,0,0"
                                    IsVisible="{Binding IsStatisticalMode}">
                                <StackPanel Spacing="4">
                                    <TextBlock Text="Diagnostics" FontSize="10" FontWeight="SemiBold" Foreground="Gray" HorizontalAlignment="Center"/>
                                    
                                    <!-- Primary Stats Row -->
                                    <StackPanel Orientation="Horizontal" Spacing="15" HorizontalAlignment="Center">
                                        <StackPanel Orientation="Horizontal" Spacing="4">
                                            <TextBlock Text="Dit:" FontSize="11" VerticalAlignment="Center"/>
                                            <TextBlock Text="{Binding DitLength}" FontSize="11" FontWeight="Bold" VerticalAlignment="Center"/>
                                            <TextBlock Text="ms" FontSize="11" VerticalAlignment="Center"/>
                                        </StackPanel>
                                        <TextBlock Text="•" FontSize="11" Foreground="LightGray" VerticalAlignment="Center"/>
                                        <StackPanel Orientation="Horizontal" Spacing="4">
                                            <TextBlock Text="Dah:" FontSize="11" VerticalAlignment="Center"/>
                                            <TextBlock Text="{Binding DahLength}" FontSize="11" FontWeight="Bold" VerticalAlignment="Center"/>
                                            <TextBlock Text="ms" FontSize="11" VerticalAlignment="Center"/>
                                        </StackPanel>
                                        <TextBlock Text="•" FontSize="11" Foreground="LightGray" VerticalAlignment="Center"/>
                                        <StackPanel Orientation="Horizontal" Spacing="4">
                                            <TextBlock Text="Measured:" FontSize="11" VerticalAlignment="Center"/>
                                            <TextBlock Text="{Binding CalculatedWpm}" FontSize="11" FontWeight="Bold" VerticalAlignment="Center"/>
                                            <TextBlock Text="WPM" FontSize="11" VerticalAlignment="Center"/>
                                        </StackPanel>
                                    </StackPanel>
                                    
                                    <!-- Secondary Stats Row -->
                                    <StackPanel Orientation="Horizontal" Spacing="4" HorizontalAlignment="Center">
                                        <TextBlock Text="Timing samples collected:" FontSize="10" Foreground="Gray" VerticalAlignment="Center"/>
                                        <TextBlock Text="{Binding SampleCount}" FontSize="10" FontWeight="Bold" Foreground="Gray" VerticalAlignment="Center"/>
                                    </StackPanel>
                                </StackPanel>
                            </Border>
                        </StackPanel>
                    </Border>
                </StackPanel>

                <!-- Exit Button (Setup page only) -->
                <Button Content="Exit"
                        Command="{Binding ExitCommand}"
                        IsVisible="{Binding IsSetupPage}"
                        HorizontalAlignment="Center"
                        HorizontalContentAlignment="Center"
                        Width="100"
                        Padding="6"/>

            </StackPanel>
        </ScrollViewer>
    </DockPanel>

</Window>
